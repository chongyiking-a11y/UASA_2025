<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slip Keputusan UASA 2025 – Edit & Cetak (Sistem Online)</title>
<style>
  :root{ --warm-border:#8b4513; --warm-header:#deb887; --warm-row:#fff7e6; --title:#6d3b10; --text:#222; --th-color:#b3261e; }
  *{box-sizing:border-box}
  body{font-family:"Segoe UI", Calibri, Arial, sans-serif; background:#fffaf0; color:var(--text); margin:0; padding:16px;}
  .wrap{max-width:1100px; margin:0 auto;}
  .toolbar, .logo-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin-bottom:12px; }
  input[type="text"], input[type="number"], select, button, textarea{ font-size:15px; padding:8px 10px; border:2px solid var(--warm-border); border-radius:10px; background:#fff; min-height:40px; }
  button{cursor:pointer}
  button.primary{ background:var(--warm-border); color:#fff }
  button.ghost{ background:#fffaf0 }
  button:disabled{ background:#ccc; border-color:#999; color:#777; cursor:not-allowed; }
  .logo-bar{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-bottom:8px;}
  .logo-bar img{ height:70px; width:auto; border-radius:8px; border:2px solid var(--warm-border); background:#fff; object-fit:contain; }
  .slip{ background:#fff; padding:20px; border:4px solid var(--warm-border); border-radius:18px; box-shadow:0 6px 18px rgba(139,69,19,.12); }
  .header{text-align:center; margin-bottom:6px;}
  .header h1{font-size:22px; margin:8px 0 0; color:var(--title); text-transform:uppercase; letter-spacing:.5px;}
  .header h2{font-size:18px; margin:6px 0 0; color:var(--title); text-transform:uppercase; letter-spacing:.5px;}
  .meta{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:12px 0 8px;}
  .meta .card{ border:2px solid var(--warm-border); border-radius:12px; padding:10px 12px; background:#fffaf0; }
  .meta b{color:#4a2a0f}
  table{width:100%; border-collapse:collapse; margin-top:6px; table-layout:fixed;}
  th, td{border:2px solid var(--warm-border); padding:8px 10px; text-align:center; word-wrap:break-word;}
  th{background:var(--warm-header); font-size:15px;}
  tbody tr:nth-child(even){ background:var(--warm-row) }
  tfoot th{ background:#f3d4a5 }
  .summary{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:12px 0; }
  .summary .box{ border:2px solid var(--warm-border); border-radius:12px; padding:10px; background:#fffaf0; text-align:center; font-size:16px; font-weight:600; }
  .ulasan-container { position: relative; }
  .ulasan{ border:2px dashed var(--warm-border); border-radius:12px; padding:12px; background:#fffdf4; margin-top:6px; min-height: 80px; }
  .ulasan-edit-btn { position: absolute; top: 8px; right: 8px; background: var(--warm-border); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
  .ulasan-edit-btn:hover { background: #6d3b10; }
  .sign{ display:flex; justify-content:space-between; gap:16px; margin-top:18px; flex-wrap:wrap; }
  .sign .line{min-width:260px}
  .sign .line::after{ content:""; display:block; border-bottom:1.5px solid #333; margin-top:50px; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px;}
  .panel{ border:2px solid var(--warm-border); border-radius:12px; padding:12px; background:#fff; }
  .panel h3{ margin:0 0 8px 0; color:var(--title); font-size:16px; }
  .form-row{ display:grid; grid-template-columns: 1.1fr 1.1fr .8fr; gap:8px; align-items:center; margin:6px 0;}
  .form-row input, .form-row select{ width:100% }
  .danger{ border-color:#b3261e; color:#b3261e }
  .ok{ border-color:#2b7a0b; color:#2b7a0b }
  .muted{ color:#6d3b10; font-size:12px }
  .mark-input-container { position: relative; }
  .mark-input-th { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; background: #fffaf0; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; }
  .mark-input-th input { width: auto; margin-right: 4px; }
  .mark-input-th label { font-size: 13px; white-space: nowrap; color: var(--th-color); font-weight: bold; }
  .th-highlight { color: var(--th-color); font-weight: bold; }
  .edit-ulasan-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
  .edit-ulasan-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
  .edit-ulasan-content textarea { width: 100%; min-height: 150px; margin: 10px 0; padding: 10px; border: 2px solid var(--warm-border); border-radius: 8px; resize: vertical; }
  .edit-ulasan-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
  .tooltip { position: relative; display: inline-block; border-bottom: 1px dotted #8b4513; cursor: help; }
  .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #8b4513; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: normal; }
  .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
  .csv-import-section { border: 2px dashed var(--warm-border); border-radius: 12px; padding: 15px; margin-top: 15px; background: #fffdf4; }
  @media print{
    body{ background:#fff; padding:0 }
    .toolbar, .logo-actions, .grid2, .ulasan-edit-btn, .mark-input-th{ display:none }
    .wrap{ max-width:none; margin:0 }
    .slip{ border-width:2px; box-shadow:none; border-radius:0; page-break-after:always }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="logo-bar">
    </div>
  <div class="logo-actions">
    <input id="logoFile" type="file" accept="image/*" />
    <button onclick="uploadLogo()">Muat Naik Logo</button>
    <button class="ghost" onclick="clearLogo()">Padam Logo</button>
  </div>

  <div class="toolbar">
    <label for="kelasSel">Kelas:</label>
    <select id="kelasSel"></select>

    <label for="studentSel">Murid:</label>
    <select id="studentSel" style="min-width:260px"></select>

    <input id="search" type="text" list="names" placeholder="Cari nama murid..." style="min-width:260px" />
    <datalist id="names"></datalist>

    <button class="primary" onclick="window.print()">Cetak / Simpan PDF</button>
    <button class="ghost" id="downloadPdfBtn">Muat Turun PDF Individu</button>
    <button class="ghost" id="downloadAllBtn">Muat Turun Semua PDF Individu</button>
    <button class="ghost" id="recalcBtn">Recalculate Kedudukan</button>
    <button class="ghost" id="exportBtn">Export JSON (Backup)</button>
    
    <input id="importFile" type="file" accept="application/json" style="display:none">
    <button class="ghost" id="importBtn" disabled>Import JSON</button>
    <input id="csvFile" type="file" accept=".csv,.xlsx,.xls" style="display:none">
    <button class="ghost" id="importCsvBtn" disabled>Import CSV/Excel</button>
  </div>

  <div id="slip" class="slip">
    <div class="header">
      
      <img id="logo" alt="Logo Sekolah" src="" style="display:none; height:70px; width:auto; margin-bottom:10px; margin-left:auto; margin-right:auto; object-fit:contain;" />
      
      <h1 id="schoolName">SEKOLAH KEBANGSAAN KORAN, SERIAN</h1>
      <h2>Pencapaian Keseluruhan Ujian Akhir Sesi Akademik (UASA) 2025</h2>
    </div>

    <div class="meta">
      <div class="card"><b>Nama Murid:</b> <span id="nama">-</span></div>
      <div class="card"><b>Kelas:</b> <span id="kelas">-</span></div>
    </div>

    <table id="markTable">
      <thead>
        <tr>
          <th style="width:55%">Mata Pelajaran</th>
          <th style="width:22%">Markah</th>
          <th style="width:23%">Gred</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th>Jumlah Markah</th>
          <th id="jumlah">-</th>
          <th id="kedudukan">Kedudukan: -</th>
        </tr>
      </tfoot>
    </table>

    <div class="summary">
      <div class="box">Jumlah: <span id="sumBox">-</span></div>
      <div class="box">Kedudukan Dalam Kelas: <span id="rankBox">-</span></div>
    </div>

    <div class="ulasan-container">
      <div class="ulasan" id="ulasan">Ulasan Guru: —</div>
      <button class="ulasan-edit-btn" onclick="openUlasanEditor()">Edit Ulasan</button>
    </div>

    <div class="sign">
      <div class="line">Tandatangan Guru Kelas</div>
      <div class="line">Tandatangan Guru Besar</div>
    </div>

    <div class="muted" style="text-align:center;margin-top:6px">
      Tip: Selepas ubah markah/gred, klik <b>Simpan Perubahan</b>.
      Gunakan <b>Recalculate Kedudukan</b> untuk kira semula kedudukan (paparan sahaja).
    </div>
  </div>

  <div class="grid2">
    <div class="panel">
      <h3>Edit Murid Terpilih</h3>
      <div class="form-row">
        <input id="nameInput" type="text" placeholder="Nama murid">
        <input id="classInput" type="text" placeholder="Nama kelas" disabled>
        <input id="rankInput" type="number" placeholder="Kedudukan">
      </div>
      <div class="form-row">
        <input id="totalInput" type="number" placeholder="Jumlah (auto)" disabled>
        <select id="autoGradeSwitch">
          <option value="on">Gred Auto (ikut markah)</option>
          <option value="off">Gred Manual</option>
        </select>
        <div></div>
      </div>
      <div id="subjectForm"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="primary" id="saveBtn">Simpan Perubahan</button>
        <button class="ghost" id="resetBtn" disabled>Reset ke Data Asal</button>
        <button class="danger" id="deleteBtn" style="border:2px solid #b3261e;background:#fff;color:#b3261e">Padam Murid</button>
      </div>
    </div>

    <div class="panel">
      <h3>Urus Kelas</h3>
      <div class="form-row">
        <input id="newName" type="text" placeholder="Nama murid baharu">
        <select id="templateSel">
          <option value="kosong">Markah kosong</option>
          <option value="purata">Auto isian purata (50 – gred C)</option>
          <option value="th">Semua Tidak Hadir (TH)</option>
        </select>
        <button id="addBtn">Tambah Murid</button>
      </div>
      
      <div class="csv-import-section" id="csv-import-section">
        <h4>Kemaskini Nama Sekolah & Peperiksaan</h4>
        <p class="muted">Nama sekolah & peperiksaan disimpan secara tempatan (LocalStorage pelayar).</p>
        <div class="form-row">
          <input id="schoolNameInput" type="text" placeholder="Nama Sekolah">
          <input id="examNameInput" type="text" placeholder="Nama Peperiksaan">
           <button class="primary" id="saveSchoolNameBtn">Simpan Nama</button>
        </div>
        <div class="muted">
          Klik 'Simpan Nama' selepas menaip untuk simpan ke pelayar ini.
        </div>
      </div>
      
      <div class="muted">
        • <b>Export JSON (Backup)</b> → muat turun data (backup) dari server.<br>
        • <b>Import JSON/CSV/Reset</b> → dimatikan kerana data kini online.<br>
        • Logo & Nama Sekolah disimpan secara tempatan (LocalStorage pelayar).
      </div>
    </div>
  </div>
</div>

<div id="editUlasanModal" class="edit-ulasan-modal">
  <div class="edit-ulasan-content">
    <h3>Edit Ulasan Guru</h3>
    <textarea id="ulasanEditor" placeholder="Tulis ulasan guru di sini..."></textarea>
    <div class="edit-ulasan-buttons">
      <button class="ghost" onclick="closeUlasanEditor()">Batal</button>
      <button class="primary" onclick="saveUlasan()">Simpan Ulasan</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// -------------------------------------------------------------------
// URL WEB APP ANDA TELAH DIMASUKKAN
// -------------------------------------------------------------------
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz17XHo1WBYZZzZtPGQ6cImutkQYZEJo_jkgW_iOA9BJWHQZ3b4rjpZrsEdQqX_0vKe/exec";
// -------------------------------------------------------------------

// Define subjects based on year level
function getSubjectsForYear(year) {
  const commonSubjects = [
    ["Bahasa Melayu", "BM"],
    ["Bahasa Inggeris", "BI"],
    ["Matematik", "MT"],
    ["Sains", "SN"],
    ["Pendidikan Jasmani & Kesihatan", "PJPK"],
    ["Pendidikan Moral", "PM"],
    ["Pendidikan Islam", "PI"],
    ["Pendidikan Seni Visual", "PSV"],
    ["Pendidikan Muzik", "PMZ"]
  ];
  // Tahun 4-6 have additional subjects
  if (year >= 4) {
    return [
      ...commonSubjects,
      ["Sejarah", "SEJ"],
      ["Reka Bentuk & Teknologi", "RBT"]
    ];
  }
  
  return commonSubjects;
}

// Determine year from class name
function getYearFromClass(className) {
  if (className.includes('1')) return 1;
  if (className.includes('2')) return 2;
  if (className.includes('3')) return 3;
  if (className.includes('4')) return 4;
  if (className.includes('5')) return 5;
  if (className.includes('6')) return 6;
  return 4; // Default to tahun 4 if cannot determine
}

function autoGrade(mark){
  if(mark===null || mark==="" || isNaN(mark)) return "";
  if(mark === "TH") return "TH";
  mark = Number(mark);
  if(mark>=82) return "A";
  if(mark>=66) return "B";
  if(mark>=50) return "C";
  if(mark>=35) return "D";
  if(mark>=20)  return "E";
  if(mark>=0) return "F";
  return "";
}

function genUlasanRingkas(s, subjects){
  const key2label = Object.fromEntries(subjects.map(([l,k])=>[k,l]));
  const m = s.m;
  const total = calcTotal(m, subjects);
  const maxTotal = subjects.length * 100;
  const percentage = (total / maxTotal) * 100;
  const rank = Number(s.rank)||null;

  // Jika ada ulasan manual DARI SERVER, gunakan itu
  if (s.ulasan && s.ulasan.trim() !== "") {
    return s.ulasan;
  }

  // Kira jumlah subjek yang tidak hadir
  const tidakHadir = Object.entries(m).filter(([key, [mark, grade]]) => 
    (mark === "TH" || grade === "TH") && key2label[key] // pastikan ia subjek yang valid
  ).length;

  // Jika semua subjek tidak hadir
  if (tidakHadir === subjects.length) {
    return "Tidak hadir keseluruhan peperiksaan. Sila berjumpa dengan guru kelas.";
  }
  
  // Jika sebahagian subjek tidak hadir
  if (tidakHadir > 0) {
    return `Tidak hadir dalam ${tidakHadir} subjek. Markah keseluruhan dipengaruhi.`;
  }

  // Jika tiada ulasan manual, hasilkan ulasan automatik
  let ringkas = "";
  if (percentage >= 82) {
    ringkas = "Pencapaian cemerlang. Teruskan usaha!";
  } else if (percentage >= 66) {
    ringkas = "Pencapaian kepujian. Boleh tingkatkan lagi.";
  } else if (percentage >= 50) {
    ringkas = "Pencapaian baik. Perlu lebih usaha.";
  } else if (percentage >= 35) {
    ringkas = "Pencapaian memuaskan. Perlu lebih usaha.";
  } else if (percentage >= 20) {
    ringkas = "Pencapaian minimum. Perlu bimbingan.";
  } else {
    ringkas = "Perlu bimbingan rapi dan latihan tambahan.";
  }

  // Identify strong and weak subjects
  const cemerlang = [];
  const lemah = [];
  for(const [k,[mark, g]] of Object.entries(m)){
    if (!key2label[k]) continue; // Skip jika subjek tidak dikenali (cth: 'ulasan')
    const label = key2label[k];
    const markNum = Number(mark) || 0;
    const gg = (g && g.trim()) ? g.trim().toUpperCase() : autoGrade(mark);
    
    if(markNum >= 85) cemerlang.push(label);
    if(markNum < 20 && markNum > 0) lemah.push(label);
  }

  // Construct feedback
  const parts = [];
  parts.push(ringkas);
  if (rank && rank <= 3) {
    parts.push(`Tahniah! Kedudukan ke-${rank} dalam kelas.`);
  }
  
  if (cemerlang.length > 0) {
    parts.push(`Subjek terbaik: ${cemerlang.slice(0, 3).join(", ")}.`);
  }
  
  if (lemah.length > 0) {
    parts.push(`Perlu perbaiki: ${lemah.slice(0, 3).join(", ")}.`);
  }
  
  // Add motivational message
  if (percentage < 20) {
    parts.push("Jangan putus asa, teruskan usaha!");
  } else if (percentage < 50) {
    parts.push("Tingkatkan lagi usaha untuk hasil lebih baik.");
  } else {
    parts.push("Teruskan kecemerlangan!");
  }

  return parts.join(" ");
}

/* LOCALSTORAGE KEYS (HANYA UNTUK LOGO & NAMA SEKOLAH) */
const LS_LOGO = "upsa_logo_base64_v2";
const LS_SCHOOL_NAME = "upsa_school_name_v2";
const LS_EXAM_NAME = "upsa_exam_name_v2";

/* DATA GLOBAL */
let DATA = []; // Data akan diisi dari server
let kelasIdx = 0;
let muridIdx = 0;

/* FUNGSI DATA SERVER (BARU) */
async function loadDataFromServer() {
  console.log("Memuat turun data dari Google Sheet...");
  document.body.style.cursor = 'wait';
  
  try {
    const response = await fetch(SCRIPT_URL);
    if (!response.ok) {
      throw new Error(`Gagal hubungi backend (Ralat ${response.status}). Semak URL Apps Script.`);
    }
    const data = await response.json();
    if (data.error) {
      throw new Error("Ralat Apps Script: " + data.error);
    }
    
    DATA = data; 
    console.log("Data diterima:", DATA);
    
    if (DATA.length > 0) {
      populateKelasDropdown();
      populateStudentDropdown();
      renderSlip();
    } else {
      alert("Tiada data diterima. Pastikan Google Sheet anda mempunyai data dan 'headers' yang betul.");
    }
    
  } catch (e) {
    console.error(e);
    alert("Gagal memuat turun data: " + e.message);
  } finally {
    document.body.style.cursor = 'default';
  }
}

async function postDataToServer(payload, successMessage) {
  console.log("Menghantar data ke server...", payload);
  document.body.style.cursor = 'wait';
  
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', 
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });
    
    console.log("Data berjaya dihantar (dianggap). Muat semula data.");
    
    setTimeout(() => {
        loadDataFromServer();
        alert(successMessage);
    }, 1500); // Tunggu 1.5 saat untuk server update

  } catch (e) {
    console.error(e);
    alert("Gagal menyimpan data: " + e.message);
    document.body.style.cursor = 'default';
  }
}


/* Logo handling (KEKAL) */
const logoImg = document.getElementById('logo');
const logoFileInput = document.getElementById('logoFile');
function loadSavedLogo(){ const saved = localStorage.getItem(LS_LOGO); if(saved){ logoImg.src = saved; logoImg.style.display = 'block'; } }
function uploadLogo(){
  const f = logoFileInput.files?.[0];
  if(!f) return alert("Sila pilih fail logo terlebih dahulu.");
  const reader = new FileReader();
  reader.onload = () => { 
    logoImg.src = reader.result; 
    logoImg.style.display = 'block'; 
    localStorage.setItem(LS_LOGO, reader.result); 
    alert("Logo dimuat naik & disimpan (dalam pelayar ini)."); 
  };
  reader.readAsDataURL(f);
}
function clearLogo(){ localStorage.removeItem(LS_LOGO); logoImg.removeAttribute('src'); logoImg.style.display = 'none'; }

/* UI refs */
const kelasSel = document.getElementById('kelasSel');
const studentSel = document.getElementById('studentSel');
const searchInput = document.getElementById('search');
const namesDL = document.getElementById('names');
const namaEl = document.getElementById('nama');
const kelasEl = document.getElementById('kelas');
const tbody = document.querySelector('#markTable tbody');
const jumlahEl = document.getElementById('jumlah');
const kedudukanEl = document.getElementById('kedudukan');
const sumBox = document.getElementById('sumBox');
const rankBox = document.getElementById('rankBox');
const ulasanEl = document.getElementById('ulasan');
const schoolNameEl = document.getElementById('schoolName');
const nameInput = document.getElementById('nameInput');
const classInput = document.getElementById('classInput');
const totalInput = document.getElementById('totalInput');
const rankInput = document.getElementById('rankInput');
const autoGradeSwitch = document.getElementById('autoGradeSwitch');
const subjectForm = document.getElementById('subjectForm');

const addBtn = document.getElementById('addBtn');
const newName = document.getElementById('newName');
const templateSel = document.getElementById('templateSel');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn'); 
const deleteBtn = document.getElementById('deleteBtn');
const recalcBtn = document.getElementById('recalcBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importCsvBtn = document.getElementById('importCsvBtn');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const downloadAllBtn = document.getElementById('downloadAllBtn');
const schoolNameInput = document.getElementById('schoolNameInput');
const examNameInput = document.getElementById('examNameInput');
const saveSchoolNameBtn = document.getElementById('saveSchoolNameBtn');

// Modal elements
const editUlasanModal = document.getElementById('editUlasanModal');
const ulasanEditor = document.getElementById('ulasanEditor');

// Load school name and exam name from localStorage (KEKAL)
const savedSchoolName = localStorage.getItem(LS_SCHOOL_NAME);
const savedExamName = localStorage.getItem(LS_EXAM_NAME);
if (savedSchoolName) {
  schoolNameEl.textContent = savedSchoolName;
  schoolNameInput.value = savedSchoolName;
}
if (savedExamName) {
  examNameInput.value = savedExamName;
}

/* Helpers */
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
function calcTotal(mobj, subjects){ 
  return subjects.reduce((sum,[label,key])=>{ 
    const val = mobj[key]?.[0]; 
    if (val === "TH") return sum;
    return sum + (isFinite(val)? Number(val):0); 
  },0);
}

function fillSubjectForm(mobj, subjects){
  subjectForm.innerHTML = "";
  subjects.forEach(([label,key])=>{
    const [mark, grade] = mobj[key] ?? ["",""];
    const isTH = mark === "TH" || grade === "TH";
    
    const row = document.createElement('div');
    row.className = 'form-row';
    row.innerHTML = `
      <input type="text" value="${label}" disabled>
      <div class="mark-input-container">
        <input type="number" min="0" max="100" step="1" data-key="${key}" class="mark-input" placeholder="Markah" value="${!isTH && mark!=="" ? mark : ""}" ${isTH ? "disabled" : ""}>
        <div class="mark-input-th">
          <input type="checkbox" data-key="${key}" class="th-checkbox" ${isTH ? "checked" : ""}>
          <label>TH</label>
        </div>
      </div>
      <input type="text" maxlength="3" data-gkey="${key}" class="grade-input" placeholder="Gred (kosong=auto)" value="${grade!=="" ? grade : ""}" title="Biarkan kosong untuk auto-grade" ${isTH ? "disabled" : ""}>
    `;
    subjectForm.appendChild(row);
    
    const thCheckbox = row.querySelector('.th-checkbox');
    const markInput = row.querySelector('.mark-input');
    const gradeInput = row.querySelector('.grade-input');
    thCheckbox.addEventListener('change', function() {
      if (this.checked) {
        markInput.value = "";
        markInput.disabled = true;
        gradeInput.value = "TH";
        gradeInput.disabled = true;
      } else {
        markInput.disabled = false;
        gradeInput.disabled = false;
        gradeInput.value = "";
      }
    });
  });
}

function renderSlip(){
  if (!DATA[kelasIdx] || !DATA[kelasIdx].murid[muridIdx]) {
    console.warn("Tiada data untuk dipaparkan. 'renderSlip' dibatalkan.");
    namaEl.textContent = "-";
    kelasEl.textContent = "-";
    tbody.innerHTML = "";
    jumlahEl.textContent = "-";
    kedudukanEl.textContent = "Kedudukan: -";
    sumBox.textContent = "-";
    rankBox.textContent = "-";
    ulasanEl.textContent = "Sila pilih murid.";
    return;
  }
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  if(!s) return;
  
  const year = getYearFromClass(kls.kelas);
  const subjects = getSubjectsForYear(year);
  
  s.total = calcTotal(s.m, subjects);
  namaEl.textContent = s.name;
  kelasEl.textContent = kls.kelas;
  tbody.innerHTML = "";

  subjects.forEach(([label,key])=>{
    const [mark, gradeManual] = s.m[key] ?? ["",""];
    const isTH = mark === "TH" || gradeManual === "TH";
    
    let finalGrade;
    if (isTH) {
      finalGrade = "TH";
    } else {
      finalGrade = (autoGradeSwitch.value==="on" || !gradeManual || gradeManual.trim()==="")
        ? autoGrade(mark)
        : gradeManual.toUpperCase();
    }
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left">${label}</td>
      <td class="${isTH ? 'th-highlight' : ''}">${isTH ? "TH" : (mark!=="" ? mark : "")}</td>
      <td class="${isTH ? 'th-highlight' : ''}">${finalGrade||""}</td>
    `;
    tbody.appendChild(tr);
  });
  jumlahEl.textContent = s.total;
  sumBox.textContent = s.total;
  kedudukanEl.textContent = "Kedudukan: " + (s.rank ?? "-");
  rankBox.textContent = s.rank ?? "-";
  ulasanEl.textContent = genUlasanRingkas(s, subjects);

  nameInput.value = s.name;
  classInput.value = kls.kelas;
  classInput.disabled = true; // Elak tukar nama kelas
  rankInput.value = s.rank ?? "";
  totalInput.value = s.total;

  fillSubjectForm(s.m, subjects);
  populateStudentDropdown();
  studentSel.value = String(muridIdx);
}

function populateKelasDropdown(){
  kelasSel.innerHTML = "";
  DATA.forEach((k, i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = k.kelas;
    kelasSel.appendChild(opt);
  });
  kelasSel.value = String(kelasIdx);
}

function populateStudentDropdown(){
  if (!DATA[kelasIdx]) return;
  const list = DATA[kelasIdx].murid;
  studentSel.innerHTML = "";
  namesDL.innerHTML = "";
  list.forEach((s,i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = s.name;
    studentSel.appendChild(opt);
    const o2 = document.createElement('option');
    o2.value = s.name; namesDL.appendChild(o2);
  });
}

function recalcRanks(){
  const kls = DATA[kelasIdx];
  if (!kls) return;
  const year = getYearFromClass(kls.kelas);
  const subjects = getSubjectsForYear(year);
  const list = kls.murid;
  list.forEach(s => s.total = calcTotal(s.m, subjects));
  const sorted = list.map((s,i)=>({s, i})).sort((a,b)=>b.s.total - a.s.total);
  let currentRank = 1, prevTotal = null, counter = 0;
  sorted.forEach(({s})=>{
    counter++;
    if(prevTotal===null || s.total < prevTotal){ currentRank = counter; prevTotal = s.total; }
    s.rank = currentRank;
  });
  renderSlip();
  alert("Kedudukan dikira semula (paparan sahaja). Klik 'Simpan Perubahan' untuk simpan kedudukan murid ini.");
}

/* Ulasan Editor Functions */
function openUlasanEditor() {
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  
  var ulasanSediaAda = s.ulasan || "";
  if (!ulasanSediaAda) {
    const year = getYearFromClass(kls.kelas);
    const subjects = getSubjectsForYear(year);
    ulasanSediaAda = genUlasanRingkas(s, subjects);
  }
  
  ulasanEditor.value = ulasanSediaAda;
  editUlasanModal.style.display = 'flex';
}

function closeUlasanEditor() {
  editUlasanModal.style.display = 'none';
}

function saveUlasan() {
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  s.ulasan = ulasanEditor.value; // Kemas kini ulasan dalam objek
  
  var payload = {
    action: "UPDATE_MURID",
    kelas: kls.kelas,
    name: s.name,
    ulasan: s.ulasan,
    m: s.m
  };

  postDataToServer(payload, "Ulasan guru telah disimpan ke server.");
  closeUlasanEditor();
}

// Import/Export (DIBUANG/DIUBAHSUAI)
importBtn.disabled = true;
importBtn.title = "Fungsi Import JSON digantikan oleh pangkalan data online.";
importCsvBtn.disabled = true;
importCsvBtn.title = "Fungsi Import CSV digantikan oleh pangkalan data online.";
resetBtn.disabled = true;
resetBtn.title = "Fungsi Reset digantikan oleh pangkalan data online.";

// Export JSON (KEKAL)
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DATA,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Backup-Data-UASA-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});

// Simpan Nama Sekolah/Peperiksaan (KEKAL)
saveSchoolNameBtn.addEventListener('click', () => {
    const schoolName = schoolNameInput.value;
    const examName = examNameInput.value;
    if (schoolName) {
        localStorage.setItem(LS_SCHOOL_NAME, schoolName);
        schoolNameEl.textContent = schoolName;
    }
    if (examName) {
        localStorage.setItem(LS_EXAM_NAME, examName);
    }
    alert("Nama sekolah/peperiksaan disimpan ke pelayar ini.");
});


/* Events */
kelasSel.addEventListener('change', ()=>{ 
  kelasIdx = +kelasSel.value || 0; 
  muridIdx = 0; 
  populateStudentDropdown();
  renderSlip(); 
});
studentSel.addEventListener('change', ()=>{ 
  muridIdx = +studentSel.value || 0; 
  renderSlip(); 
});
searchInput.addEventListener('change', ()=>{
  const term = searchInput.value.trim().toLowerCase();
  const idx = DATA[kelasIdx].murid.findIndex(s=>s.name.toLowerCase()===term);
  if(idx>=0){ muridIdx = idx; renderSlip(); }
});

// DIUBAHSUAI: Hantar ke server
saveBtn.addEventListener('click', ()=>{
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  const year = getYearFromClass(kls.kelas);
  const subjects = getSubjectsForYear(year);

  // Kumpul semua data yang diubah
  const newNameVal = nameInput.value.trim();
  if(newNameVal) s.name = newNameVal;
  s.rank = rankInput.value ? Number(rankInput.value) : s.rank;

  const markInputs = subjectForm.querySelectorAll('.mark-input');
  markInputs.forEach(inp=>{
    const key = inp.dataset.key;
    const thCheckbox = subjectForm.querySelector(`.th-checkbox[data-key="${key}"]`);
    
    if (thCheckbox.checked) {
      s.m[key] = ["TH", "TH"];
    } else {
      let val = inp.value === "" ? "" : Math.max(0, Math.min(100, Number(inp.value)));
      const gradeInp = subjectForm.querySelector(`.grade-input[data-gkey="${key}"]`);
      let g = gradeInp.value.trim().toUpperCase();
      if(autoGradeSwitch.value==="on") g = "";
      s.m[key] = [val, g];
    }
  });
  
  // Sediakan payload untuk dihantar ke server
  var payload = {
    action: "UPDATE_MURID",
    kelas: kls.kelas, // Nama kelas (Tab)
    name: s.name,     // Nama murid (untuk cari baris)
    ulasan: s.ulasan || "", // Ulasan (jika ada)
    m: s.m            // Objek markah
  };

  postDataToServer(payload, "Perubahan telah disimpan ke server.");
});


// DIUBAHSUAI: Hantar ke server
deleteBtn.addEventListener('click', ()=>{
  if(!confirm("Padam murid ini dari server? Tindakan ini kekal.")) return;
  
  const kls = DATA[kelasIdx];
  const s = kls.murid[muridIdx];
  
  var payload = {
    action: "DELETE_MURID",
    kelas: kls.kelas,
    name: s.name
  };
  
  postDataToServer(payload, "Murid telah dipadam dari server.");
  muridIdx = 0; // Reset paparan ke murid pertama
});

// DIUBAHSUAI: Hantar ke server
addBtn.addEventListener('click', ()=>{
  const n = newName.value.trim();
  if(!n){ alert("Sila isi nama murid baharu."); return; }
  const tmpl = templateSel.value;
  const kls = DATA[kelasIdx];
  const year = getYearFromClass(kls.kelas);
  const subjects = getSubjectsForYear(year);
  
  const m = {};
  subjects.forEach(([_,key])=>{
    if(tmpl==="purata"){ m[key] = [50,""]; }
    else if(tmpl==="th") { m[key] = ["TH","TH"]; }
    else { m[key] = ["",""]; }
  });
  
  var payload = {
    action: "ADD_MURID",
    kelas: kls.kelas,
    name: n,
    ulasan: "",
    m: m
  };
  
  postDataToServer(payload, "Murid baharu telah ditambah ke server.");
  newName.value = "";
});

recalcBtn.addEventListener('click', recalcRanks);

/* PDF Download Functions (KEKAL) */
function sanitizeFilename(name){
  return name.replace(/[^A-Za-z0-9\s\-]/g, '').trim().replace(/\s+/g, '_');
}
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}
async function downloadPdfPromise(index){
  const kls = DATA[kelasIdx];
  if (!kls || !kls.murid[index]) {
      alert("Gagal jana PDF: Data murid tidak ditemui.");
      return;
  }
  muridIdx = index;
  renderSlip();
  const logoEl = document.getElementById('logo');
  if (logoEl.src && logoEl.src.trim() !== "") {
    try {
      await loadImage(logoEl.src);
    } catch (e) {
      console.warn("Logo tidak dapat dimuat, meneruskan tanpa logo");
    }
  }

  const element = document.getElementById('slip');
  const namePart = sanitizeFilename(DATA[kelasIdx].murid[muridIdx].name).toUpperCase();
  const filename = `${namePart}-UPSA2025.pdf`;
  const opt = {
    margin: [10, 10, 10, 10],
    filename: filename,
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: { 
      scale: 2, 
      useCORS: true, 
      logging: false,
      onclone: function(clonedDoc) {
        // Paparkan logo dalam klon
        const clonedLogo = clonedDoc.getElementById('logo');
        if (clonedLogo && logoEl.src && logoEl.src.trim() !== "") {
          clonedLogo.style.display = "block";
        }
        
        // === INI KOD BARU YANG DITAMBAH ===
        // Cari butang 'Edit Ulasan' dalam klon dan sembunyikannya
        const clonedEditButton = clonedDoc.querySelector('.ulasan-edit-btn');
        if (clonedEditButton) {
          clonedEditButton.style.display = 'none';
        }
        // === TAMAT KOD BARU ===
      }
    },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  return html2pdf().set(opt).from(element).save();
}

function downloadPdf(){
  downloadPdfPromise(muridIdx).catch(err=>{ 
    console.error(err); 
    alert("Gagal muat turun PDF: " + err.message); 
  });
}

async function downloadAllPdf(){
  if(!confirm("Muat turun semua slip dalam kelas ini? Mungkin ambil masa.")) return;
  const kls = DATA[kelasIdx];
  const total = kls.murid.length;
  let done = 0;
  
  for (let i = 0; i < total; i++) {
    try {
      await downloadPdfPromise(i);
      done++;
    } catch (err) {
      console.error(err);
      alert(`Gagal muat turun slip ${kls.murid[i].name}.`);
    }
  }
  
  alert(`Selesai: ${done}/${total} slip dimuat turun.`);
}

downloadPdfBtn.addEventListener('click', downloadPdf);
downloadAllBtn.addEventListener('click', downloadAllPdf);
autoGradeSwitch.addEventListener('change', renderSlip);

/* Init */
loadSavedLogo(); 

// Mulakan aplikasi dengan memuat turun data dari server
loadDataFromServer(); 
</script>
</body>
</html>

